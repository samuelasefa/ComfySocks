
@{
    ViewBag.Title = "New Purchase Entry";
}
<link href="~/Scripts/AdminLTE/plugins/iCheck/square/red.css" rel="stylesheet" />
<link href="~/Scripts/AdminLTE/plugins/iCheck/minimal/minimal.css" rel="stylesheet" />
<script src="~/Scripts/AdminLTE/plugins/iCheck/icheck.min.js"></script>

<!--*********** modal for suppliers ********** -->
<div id="modal_supplier" class="modal fade bs-example-modal-sm" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="FormAddSupplier">
                @Html.AntiForgeryToken()
                SupplierName : <input type="text" name="suppliername" /><br />
                Supplier's Invoice No:<input type="text" name="invoicenumber" /><br />
                <button id="addSupplier">Add</button>
            </form>
        </div>
    </div>
</div>
<script>
    $('#renderSupplierForm')
    .html("Loading...")
    .load('@Url.Action("_SupplierCreatePV", "Supplier")');

    $('#addSupplier'.on('click', function () {
        $post('../../../Supplier/Create', $('FormAddSupplier').serialize(), function (data) {
            $('#modal_supplier').modal('toggle');
            if (data == 'duplicate') {
                alert("Duplicate Data!");
            }
            else {
                populateSupplier();
                alert("Success");
            }
        }, "Json");
        return false;
    });
</script>

<!--*********** End modal for suppliers **********-->

<div class="box box-primary box-body">
    <div class="row">
        <div class="col-md-3">
            Supplier <br />
            <select id="SelectSupplier" class="form-control"></select>
            <span class="error">Required field</span>
        </div>
        <div class="col-md-3">
            Supplier Invoice No. <br />
            <select id="SupplierInvoice" class="form-control"></select>
            <span class="error">Required field</span>
        </div>

        <div class="col-md-3">
            PurchaseID<br />
            <input type="text" id="PurchaseID" class="form-control" />
            <span class="error"> Required field !</span>
        </div>
        <div class="col-md-3">
            Date<br />
            <input type="text" id="InvocingDate" class="form-control datepicker checkDateNoGraterThanToday" />
            <span class="error"> Required field !</span>
        </div>
    </div>

    <hr />
    <div class="row">
        <div class="col-sm-4">
            <div class="row">
                <div class="col-sm-4">Item</div>
                <div class="col-sm-8"><select id="selectItem" class="form-control"></select><span class="error">Required field!</span></div>
            </div>
            <div class="row">
                <div class="col-sm-4">Quantity</div>
                <div class="col-sm-8"><input type="number" id="Qty" class="form-control NumbersOnly CheckFirstCharIsZero" /><span class="error"> Required field !</span></div>
            </div>
            <div class="row">
                <div class="col-sm-4">Unit Price</div>
                <div class="col-sm-8"><input type="text" id="UP" class="form-control NumbersAndDecimal" /><span class="error"> Required field !</span></div>
            </div>
            <div class="row">
                <div class="col-sm-4"></div>
                <div class="col-sm-8"><button type="button" id="btnAdd" class="btn btn-primary">Add to list</button></div>
            </div>
        </div>
        <div class="col-sm-8">
            <div style=" background-color:#34495e; color:white; padding:10px">Purchase Items</div>
            @********table here***********@
            <div id="orderItems" class="tablecontainer" style="height:260px; overflow-y:scroll; border:1px solid #BFAEAE">
            </div>
            <div>
                <br />
                <button style="padding: 5px 30px 5px 30px" type="button" class="btn btn-primary pull-right" id="btnNext" data-toggle="modal" data-target="#myModal">
                    Next <span class="glyphicon glyphicon-triangle-right"></span>
                </button>
            </div>
        </div>
    </div>
</div>

<!--=========JAVA SCRIPT=========-->
@*populating supplier*@
<script>
    function populateSupplier() {
        $.get('/PurchaseEntry/PopulateSupplier', {}, function (data) {
            $('#SelectSupplier').empty();
            $('#SelectSupplier').append($("<option value='0'>--Select Number--</option>"));
            $.each(data, function (key, value) {
                $('#SelectSupplier').append($("<option></option>").val(value.ID).html(value.Name));
            });
        }, 'json');
    }

    //populate invoice of supplier
    $.get('/PurchaseEntry/PopulateSupplierInvoice', {}, function (data) {
        $('#SupplierInvoice').empty();
        $('#SupplierInvoice').append($("<option value='0'>--Select Invoice Supplier--</option>"));
        $.each(data, function (key, value) {
            $('#SupplierInvoice').append($("<option></option>").val(value.ID).html(value.InvoiceNumber));
        });
    }, 'json');

    //datepicker
    $(function () {
        $(".datepicker").datepicker({
            format: 'yyyy-mm-dd'
        });
    });

    //populating supplier dropdown
    populateSupplier();

    //populating Items dropdown
    $.get('/PurchaseEntry/PopulateItem', {}, function (data) {
        $('#selectItem').empty();
        $('#selectItem').append($("<option value='0'>--Select Items--</option>"))
        $.each(data, function (key, value) {
            $('#selectItem').append($('<option></option>').val(value.ID).html(value.Description));
        });
    }, 'json');

    //adding item to item box
    var purchaseItems = [];
    $('#btnAdd').on('click', function () {

        //jQuery Validations
        //supplier selected or not
        var isValidation = true;
        if ($('#SelectSupplier').val() == "0") {
            isValidation = false;
            $('#SelectSupplier').siblings('span.error').css('visibility', 'visible');
        }
        else {
            $('#SelectSupplier').siblings('span.error').css('visibility', 'hidden');
        }
        //PurchaseId is added or not
        if ($('#PurchaseID').val().trim() == '') {
            isValidation = false;
            $('#PurchaseID').siblings('span.error').css('visibility', 'visible');
        }
        else {
            $('#PurchaseID').siblings('span.error').css('visibility', 'hidden');
        }
        //invoiceDate added or not
        if ($('#InvocingDate').val() == '') {
            isValidation = false;
            $('#InvocingDate').siblings('span.error').css('visibility', 'visible');
        }
        else {
            $('#InvocingDate').siblings('span.error').css('visibility', 'hidden');
        }
        //if item are selected or not
        if ($('#selectItem').val() == "0") {
            isValidation = false;
            $('#selectItem').siblings('span.error').css('visibility', 'visible');
        }
        else {
            $('#selectItem').siblings('span.error').css('visibility', 'hidden');
        }
        //if quantit are added or not
        if ($('#Qty').val() == '') {
            isValidation = false;
            $('#Qty').siblings('span.error').css('visibility', 'visible');
        }
        else {
            $('#Qty').siblings('span.error').css('visibility', 'hidden');
        }
        //if unit price is add or not
        if ($('#UP').val() == '' || isNaN($('#UP').val().trim())) {
            isValidation = false;
            $('#UP').siblings('span.error').css('visibility', 'visible');
        }
        else {
            $('#UP').siblings('span.error').css('visibility', 'hidden');
        }
        //PUSH to purchase itembox
        if (isValidation) {
            purchaseItems.push({
                ItemID: $('#selectItem').val(),
                Description: $('#selectItem option:selected').text(),
                Quantity: $('#Qty').val(),
                UnitPrice: $('#UP').val(),
                PurchaseID: $('#PurchaseID').val() + ' / ' + $('#SelectSupplier').val(),
            });
            $('#selectItem').val('0').focus();
            $('#Qty, #UP').val('');
        }
        GeneratedItemsTable();
    });

    //GeneratedItemTable function
    function GeneratedItemsTable() {
        if (purchaseItems.length > 0) {
            var $table = $('<table id="mytable" class="table table-striped table-hover"/>');
            $table.append('<thead><tr style="background-color:rgb(201, 211, 218);"><th>ItemID</th><th>Description</th><th>Quantity</th><th>UP</th><th>Delete</th></tr></thead>')
            var $tbody = $('<tbody/>');

            $.each(purchaseItems, function (i, val) {
                var $row = $('<tr/>');
                $row.append($('<td/>').html(val.ItemID));
                $row.append($('<td/>').html(val.Description));
                $row.append($('<td/>').html(val.Quantity));
                $row.append($('<td/>').html(val.UnitPrice));
                $row.append($('<td/>').html('<a href=# onclick="removeItem(this)" ><span class="glyphicon glyphicon-trash"></span></a>'));
                $tbody.append($row);

            });
            $table.append($tbody);
            $('#orderItems').html($table);
        }
        else {
            alert("List is empty !");
        }
    
}
    //removes record on clicking remove icon and associated array
    function removeItem(obj) {
        var $index = $(obj).parent().parent()[0].sectionRowIndex;
        alert($index);
        purchaseItems.splice($index, 1);
        $(obj).parent().parent().remove();
        GeneratedItemsTable();
    }
</script>


<style>

    /*Adding some css for looks good*/
    span.error {
        display: block;
        visibility: hidden;
        color: red;
        font-size: 90%;
    }
</style>

